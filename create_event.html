<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>建立飲料訂單</title>
  <link rel="stylesheet" href="css/create_event_style.css">
  <link rel="stylesheet" href="css/loading.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="wrap">
    <h1 class="page-title">建立飲料訂單</h1>

    <div id="createCard" class="card">
      <label for="shopSelect">店家</label>
      <select id="shopSelect" class="select-like">
        <option value="" selected>請選擇店家</option>
        <option>迷客夏</option>
        <option>大茗本味製茶堂</option>
        <option>珍煮丹</option>
        <option>得正</option>
        <option>50嵐</option>
        <option>麻古茶坊</option>
        <option>一沐日</option>
        <option value="__other">其他（自訂）</option>
      </select>

      <div id="otherBox" class="hidden" style="margin-top:10px;">
        <input id="shopOther" placeholder="請輸入店家名稱">
      </div>

      <label for="deadline" style="margin-top:12px;">截止時間</label>
      <input id="deadline" type="datetime-local" />

      <div class="actions">
        <a class="back-home" href="index.html">回首頁</a>
        <button class="primary" id="createBtn" type="button">建立訂單</button>
      </div>

      <div id="result" style="margin-top:16px; display:none;">
        <p>分享這個連結給大家下單：</p>
        <input id="shareLink" readonly style="width:100%;height:44px;padding:10px 12px;border:1px solid #ccc;border-radius:10px;">
        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="copyBtn" type="button">複製下單連結</button>
        </div>
      </div>
    </div>
  </div>

  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      <div class="spinner-text">處理中，請稍候...</div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const { SUPABASE_URL, SUPABASE_KEY } = window.APP_CONFIG;

    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function showLoading(){ document.getElementById('loadingOverlay').style.display='block'; }
    function hideLoading(){ document.getElementById('loadingOverlay').style.display='none'; }

    const shopSelect = document.querySelector('#shopSelect');
    const otherBox = document.querySelector('#otherBox');
    const shopOther = document.querySelector('#shopOther');
    shopSelect.addEventListener('change', () => {
      if (shopSelect.value === '__other') {
        otherBox.classList.remove('hidden');
        shopOther.focus();
      } else {
        otherBox.classList.add('hidden');
        shopOther.value = '';
      }
    });

    async function createEvent(){
      const sel = shopSelect.value;
      const shop = sel === '__other' ? shopOther.value.trim() : sel.trim();
      const deadline = document.querySelector('#deadline').value;

      if (!shop) return alert('請選擇店家或輸入自訂店名');

      showLoading();
      try {
        const { data, error } = await _supabase
          .from('events')
          .insert([
            {
              title: shop + ' 訂單',
              shop: shop,
              deadline: deadline ? new Date(deadline).toISOString() : null,
              status: 'open'
            }
          ])
          .select(); // 使用 select() 獲取剛建立的資料（包含 ID）

        if (error) throw error;

        const newEvent = data[0];
        const id = newEvent.id;

        const orderURL = new URL('order.html', location.href);
        orderURL.searchParams.set('event', id);
        const orderLink = orderURL.toString();

        const input = document.querySelector('#shareLink');
        input.value = orderLink;
        document.querySelector('#result').style.display = 'block';

        document.querySelector('#copyBtn').onclick = async () => {
          try {
            await navigator.clipboard.writeText(orderLink);
            alert('已複製下單連結');
          } catch (e) {
            input.select();
            document.execCommand('copy');
            alert('已複製');
          }
        };

      } catch (err) {
        alert('建立失敗：' + err.message);
      } finally {
        hideLoading();
      }
    }

    document.querySelector('#createBtn').addEventListener('click', createEvent);
  </script>
</body>
</html>