<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>建立訂單</title>
    <link rel="stylesheet" href="css/create_event_style.css" />
    <link rel="stylesheet" href="css/loading.css" />
    <link rel="stylesheet" href="css/copyright_style.css" />
  </head>
  <body>
    <div class="wrap">
      <h1 class="page-title">建立訂單</h1>

      <div id="createCard" class="card">
        <label>選擇訂單類型</label>
        <div class="category-toggle">
          <button type="button" id="btnDrink" class="toggle-btn active">飲料區</button>
          <button type="button" id="btnFood" class="toggle-btn">餐點區</button>
        </div>

        <label for="shopSelect">店家</label>
        <select id="shopSelect" class="select-like"></select>

        <div id="otherBox" class="hidden">
          <input id="shopOther" placeholder="請輸入店家名稱" />
        </div>

        <label for="deadline">截止時間</label>
        <input id="deadline" type="datetime-local" />

        <div class="actions">
          <a class="back-home" href="index.html">回首頁</a>
          <button class="primary" id="createBtn" type="button">建立訂單</button>
        </div>

        <div id="result" class="hidden">
          <hr class="divider" />

          <button id="directGoBtn" type="button">直接進入點餐</button>

          <hr class="divider" />

          <label>分享給團員</label>
          <textarea
            id="shareMsg"
            class="share-textarea"
            readonly
            rows="5"
          ></textarea>
          <div class="actions action-gap" style="margin-top: 10px">
            <button class="primary" id="copyBtn" type="button">複製分享訊息</button>
          </div>
        </div>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="spinner-box">
        <div class="spinner"></div>
        <div class="spinner-text">處理中，請稍候...</div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <p>© 2025 - 2026 曾可愛家族點餐系統</p>
        <p class="disclaimer">本站所有品牌標誌及菜單資訊之著作權均屬原公司所有。</p>
      </div>
    </footer>

    <script type="module">
      import { supabase } from "./config.js";

      const drinkShops = [
        "迷客夏",
        "大茗本味製茶堂",
        "珍煮丹",
        "得正",
        "50嵐",
        "米里米里",
        "麻古茶坊",
        "八曜和茶",
        "有飲",
        "青山茶行",
        "清心福全",
        "一沐日",
        "波哥茶飲",
        "双生綠豆沙牛奶",
        "來日方茶",
        "茶湯會",
        "老賴茶棧",
        "可不可熟成紅茶",
      ];
      const foodShops = [
        "露西媽媽",
        "桂記手工水餃",
        "老曾牛肉麵",
        "劉家鴨肉",
        "作伙來",
        "豐當歸鴨",
        "牛族",
        "豐當歸鴨",
        "丹丹漢堡",
        "漢堡王",
        "麥當勞",
        "肯德基",
        "阿珍炸雞",
      ];

      let currentCategory = "drink";
      const shopSelect = document.querySelector("#shopSelect");
      const otherBox = document.querySelector("#otherBox");
      const shopOther = document.querySelector("#shopOther");
      const btnDrink = document.getElementById("btnDrink");
      const btnFood = document.getElementById("btnFood");

      function updateShopList(category) {
        currentCategory = category;
        const list = category === "drink" ? drinkShops : foodShops;
        shopSelect.innerHTML = '<option value="" selected>請選擇店家</option>';
        list.forEach((shop) => {
          const opt = document.createElement("option");
          opt.value = shop;
          opt.textContent = shop;
          shopSelect.appendChild(opt);
        });
        shopSelect.innerHTML += '<option value="__other">其他（自訂）</option>';
      }

      btnDrink.onclick = () => {
        btnDrink.classList.add("active");
        btnFood.classList.remove("active");
        updateShopList("drink");
      };

      btnFood.onclick = () => {
        btnFood.classList.add("active");
        btnDrink.classList.remove("active");
        updateShopList("food");
      };

      shopSelect.addEventListener("change", () => {
        if (shopSelect.value === "__other") {
          otherBox.classList.remove("hidden");
        } else {
          otherBox.classList.add("hidden");
          shopOther.value = "";
        }
      });

      async function createEvent() {
        const sel = shopSelect.value;
        const shop = sel === "__other" ? shopOther.value.trim() : sel.trim();
        const deadline = document.querySelector("#deadline").value;

        if (!shop) return alert("請選擇店家或輸入店名");

        document.getElementById("loadingOverlay").style.display = "block";
        try {
          const { data, error } = await supabase
            .from("events")
            .insert([
              {
                title: shop + " 訂單",
                shop: shop,
                category: currentCategory,
                deadline: deadline ? new Date(deadline).toISOString() : null,
                status: "open",
              },
            ])
            .select();

          if (error) throw error;

          const id = data[0].id;
          const orderURL = new URL("order.html", location.href);
          orderURL.searchParams.set("event", id);

          let deadlineText = "無期限";
          if (deadline) {
            const d = new Date(deadline);
            deadlineText = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, "0")}:${String(d.getMinutes()).padStart(2, "0")}`;
          }

          const finalMsg = `你好，這是 ${shop} 的訂單，請你於 ${deadlineText} 之前進行點餐。\n\n 點餐連結：${orderURL.toString()}`;

          document.querySelector("#shareMsg").value = finalMsg;
          document.querySelector("#result").classList.remove("hidden");

          document.getElementById("directGoBtn").onclick = () => {
            location.href = orderURL.toString();
          };

          document.querySelector("#copyBtn").onclick = async () => {
            await navigator.clipboard.writeText(finalMsg);
            alert("分享訊息已複製到剪貼簿！");
          };
        } catch (err) {
          alert("建立失敗：" + err.message);
        } finally {
          document.getElementById("loadingOverlay").style.display = "none";
        }
      }

      document.querySelector("#createBtn").onclick = createEvent;
      updateShopList("drink");
    </script>
  </body>
</html>
