<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>下單 Order</title>
  <link rel="stylesheet" href="css/order_style.css">
</head>

<body>
  <div class="wrap">
    <h1 class="page-title">下單</h1>
    <div class="card">
      <div class="name-grid">
        <label>姓名</label>
        <input  id="customer" name="customer">
      </div>
      <div style="margin-top:10px;">
        <table id="itemsTbl">
          <thead>
            <tr>
              <th>飲料名稱</th><th>糖度</th><th>冰量</th><th>數量</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button type="button" class="add" id="addItem">新增一筆</button>
        </div>
      </div>

      <div class="actions" style="margin-top:16px;">
        <a href="index.html" class="back-home">回首頁</a>
        <button type="button" class="primary" id="submitBtn">送出訂單</button>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwftAeTHXYAcyHCHJN8rs6Rxr1_cKjkPj8IkucuDFo4iQsrE1zunjJiUWgA-b_YRIQ/exec';

    function addRow(defaults={}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input value="${defaults.name||''}"></td>
        <td>
          <select>
            <option value="">—</option>
            <option>無糖</option><option>微糖</option><option>半糖</option><option>少糖</option><option>正常</option>
          </select>
        </td>
        <td>
          <select>
            <option value="">—</option>
            <option>去冰</option><option>微冰</option><option>少冰</option><option>正常</option>
          </select>
        </td>
        <td><input class="qty" type="number" min="1" value="${defaults.qty||1}"></td>
        <td><button type="button" class="del">刪</button></td>
      `;
      document.querySelector('#itemsTbl tbody').appendChild(tr);
      tr.querySelector('.del').addEventListener('click',()=>tr.remove());
    }

    function collectItems() {
      return [...document.querySelectorAll('#itemsTbl tbody tr')].map(tr=>{
        const [name,sugar,ice,qty] = tr.querySelectorAll('input,select');
        return {
          name:name.value.trim(),
          sugar:sugar.value,
          ice:ice.value,
          qty:Number(qty.value||0)
        };
      }).filter(it=>it.name && it.qty>0);
    }

    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.random().toString(36).slice(2);
        params.callback = cb;
        const qs = new URLSearchParams(params).toString();
        const s = document.createElement('script');
        s.src = url + '?' + qs;

        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = () => { reject(new Error('JSONP failed')); cleanup(); };
        function cleanup(){ delete window[cb]; s.remove(); }

        document.body.appendChild(s);
      });
    }

    async function submitOrder(ev){
      ev?.preventDefault();
      const customer = document.querySelector('#customer').value.trim();
      const items = collectItems();
      if (!customer) return alert('請填寫姓名');
      if (!items.length) return alert('請至少新增一筆飲料');

      try {
        const payload = { customer, items };
        const res = await jsonp(WEB_APP_URL, { payload: JSON.stringify(payload) });
        if (!res.ok) throw new Error(res.error || '下單失敗');

        alert(`下單成功！已寫入試算表`);
      } catch(err){
        alert('下單失敗：'+(err?.message||err));
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelector('#addItem').addEventListener('click',()=>addRow());
      document.querySelector('#submitBtn').addEventListener('click',submitOrder);
      addRow();
    });
  </script>
</body>
</html>
