<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>下單 Order</title>
<style>
.wrap{
  max-width:1100px;
  margin:56px auto;
  padding:0 24px;
}
.card{
  background:#fff;
  padding:28px 32px;
  border-radius:16px;
  box-shadow:0 4px 20px rgba(0,0,0,.05);
}

label{
  display:block;
  margin:12px 0 8px;
  font-size:15px;
  font-weight:700;
}
input,select{
  width:100%;
  height:52px;
  box-sizing:border-box;
  padding:12px 16px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ccc;
}

:root{
  --col-grid:minmax(220px,.6fr) 180px 180px 120px 64px;
  --gap:12px;
}

table{
  width:100%;
  border-collapse:separate;
  border-spacing:0 16px;
  margin-top:14px;
}
table thead tr,
table tbody tr{
  display:grid;
  grid-template-columns:var(--col-grid);
  column-gap:var(--gap);
  align-items:center;
}
table thead th{
  margin:0;
  padding:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
}
table thead th:first-child{
  justify-content:center;
  text-align:center;
  justify-self:center;
  width:min(100%,360px);
}
table thead th:last-child{
  justify-content:flex-end;
}
td>input,
td>select{
  width:100%;
}
td:nth-child(4) input{
  text-align:center;
}
td:last-child{
  display:flex;
  justify-content:flex-end;
}
td:first-child{
  justify-self:center;
}
td:first-child>input{
  width:min(100%,360px);
}

.name-grid{
  display:grid;
  grid-template-columns:var(--col-grid);
  column-gap:var(--gap);
  justify-items:center;
  margin-bottom:14px;
}
.name-grid>label{
  grid-column:1/2;
  align-self:end;
  margin:0 0 6px;
  text-align:center;
}
.name-grid>#customer{
  grid-column:1/2;
  justify-self:center;
  width:min(100%,360px);
}

.actions{
  display:flex;
  gap:12px;
  justify-content:flex-end;
  margin-top:18px;
}
button{
  padding:10px 16px;
  border:none;
  border-radius:10px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}
.add{
  background:#e9e9e9;
}
.primary{
  background:#111;
  color:#fff;
}
.del{
  background:#f0f0f0;
  padding:8px 12px;
}

@media (max-width:900px){
  .wrap{
    padding:0 16px;
    margin:32px auto;
  }
  input,select{
    height:48px;
    font-size:15px;
  }
  table thead{
    display:none;
  }
  table tbody tr{
    grid-template-columns:1fr 1fr;
    gap:12px;
    padding:10px;
    border-radius:12px;
    background:#fff;
  }
  td:last-child{
    grid-column:2/3;
    justify-content:end;
  }
  .name-grid{
    grid-template-columns:1fr 1fr;
  }
  .name-grid>label{
    grid-column:1/-1;
    text-align:center;
  }
  .name-grid>#customer{
    grid-column:1/-1;
    width:100%;
  }
}

@media (min-width:1280px){
  .wrap{
    max-width:1200px;
  }
  .card{
    padding:32px 36px;
  }
  input,select{
    height:56px;
  }
}

</style>
</head>

<body>
  <div class="wrap">
    <h1>下單</h1>
    <div class="card">
      <div class="name-grid">
        <label>姓名</label>
        <input  id="customer" name="customer" placeholder="例如：小明">
      </div>
      <div style="margin-top:10px;">
        <table id="itemsTbl">
          <thead>
            <tr>
              <th>飲料</th><th>糖度</th><th>冰量</th><th>數量</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="actions">
          <button type="button" class="add" id="addItem">＋新增一筆</button>
        </div>
      </div>

      <div class="actions" style="margin-top:16px;">
        <button type="button" class="primary" id="submitBtn">送出訂單</button>
      </div>
    </div>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwftAeTHXYAcyHCHJN8rs6Rxr1_cKjkPj8IkucuDFo4iQsrE1zunjJiUWgA-b_YRIQ/exec';

    function addRow(defaults={}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input placeholder="飲料名稱" value="${defaults.name||''}"></td>
        <td>
          <select>
            <option value="">—</option>
            <option>無糖</option><option>微糖</option><option>半糖</option><option>少糖</option><option>正常</option>
          </select>
        </td>
        <td>
          <select>
            <option value="">—</option>
            <option>去冰</option><option>微冰</option><option>少冰</option><option>正常</option>
          </select>
        </td>
        <td><input class="qty" type="number" min="1" value="${defaults.qty||1}"></td>
        <td><button type="button" class="del">刪</button></td>
      `;
      document.querySelector('#itemsTbl tbody').appendChild(tr);
      tr.querySelector('.del').addEventListener('click',()=>tr.remove());
    }

    function collectItems() {
      return [...document.querySelectorAll('#itemsTbl tbody tr')].map(tr=>{
        const [name,sugar,ice,qty] = tr.querySelectorAll('input,select');
        return {
          name:name.value.trim(),
          sugar:sugar.value,
          ice:ice.value,
          qty:Number(qty.value||0)
        };
      }).filter(it=>it.name && it.qty>0);
    }

    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Date.now() + Math.random().toString(36).slice(2);
        params.callback = cb;
        const qs = new URLSearchParams(params).toString();
        const s = document.createElement('script');
        s.src = url + '?' + qs;

        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = () => { reject(new Error('JSONP failed')); cleanup(); };
        function cleanup(){ delete window[cb]; s.remove(); }

        document.body.appendChild(s);
      });
    }

    async function submitOrder(ev){
      ev?.preventDefault();
      const customer = document.querySelector('#customer').value.trim();
      const items = collectItems();
      if (!customer) return alert('請填寫姓名');
      if (!items.length) return alert('請至少新增一筆飲料');

      try {
        const payload = { customer, items };
        const res = await jsonp(WEB_APP_URL, { payload: JSON.stringify(payload) });
        if (!res.ok) throw new Error(res.error || '下單失敗');

        alert(`下單成功！已寫入試算表`);
      } catch(err){
        alert('下單失敗：'+(err?.message||err));
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded',()=>{
      document.querySelector('#addItem').addEventListener('click',()=>addRow());
      document.querySelector('#submitBtn').addEventListener('click',submitOrder);
      addRow();
    });
  </script>
</body>
</html>
