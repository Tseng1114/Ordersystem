<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>下單 - 曾可愛家族點餐系統</title>
    <link rel="stylesheet" href="css/order_style.css" />
    <link rel="stylesheet" href="css/loading.css" />
    <link rel="stylesheet" href="css/copyright_style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="wrap">
      <h1 class="page-title">下單</h1>
      <div class="card">
        <table id="itemsTbl">
          <thead>
            <tr id="tableHeader">
              <th>姓名</th>
              <th id="itemName">品項</th>
              <th id="colSpecA">糖度</th>
              <th id="colSpecB">冰量</th>
              <th>數量</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="actions">
          <a href="index.html" class="back-home">回首頁</a>
          <button type="button" class="add" id="addItem">＋新增一筆</button>
          <button type="button" class="primary" id="submitBtn">送出訂單</button>
        </div>
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="spinner-box">
        <div class="spinner"></div>
        <div class="spinner-text">處理中，請稍候...</div>
      </div>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <p>© 2025 - 2026 曾可愛家族點餐系統</p><p class="disclaimer">本站所有品牌標誌及菜單資訊之著作權均屬原公司所有。本系統為非營利開發練習，與上述品牌無官方關聯。</p>
      </div>
    </footer>

    <script type="module">
      import { supabase } from "./config.js";

      const urlParams = new URLSearchParams(window.location.search);
      const EVENT_ID = urlParams.get("event");
      let currentCategory = "drink";
      let isExpired = false; 

      function showLoading(s) {
        document.getElementById("loadingOverlay").style.display = s
          ? "block"
          : "none";
      }

      async function ensureEvent() {
        if (!EVENT_ID) return alert("無效訂單編號");
        showLoading(true);
        try {
          const { data: ev, error } = await supabase
            .from("events")
            .select("*")
            .eq("id", EVENT_ID)
            .single();

          if (error || !ev) return alert("找不到該訂單");

          currentCategory = ev.category || "drink";
          document.querySelector(".page-title").textContent =
            ev.shop + " - 下單";

          if (currentCategory === "food") {
            document.getElementById("itemName").textContent = "餐點名稱";
            document.getElementById("colSpecA").textContent = "份量";
            document.getElementById("colSpecB").textContent = "備註";
          }

          if (ev.deadline) {
            const now = new Date();
            const deadlineTime = new Date(ev.deadline);
            if (now > deadlineTime) {
              isExpired = true;
              const btn = document.getElementById("submitBtn");
              btn.disabled = true;
              btn.innerText = "已截止 (無法送出)";
              btn.classList.add("btn-disabled"); 
              document.getElementById("addItem").classList.add("hidden");
              alert("此訂單已截止。");
            }
          }
        } finally {
          showLoading(false);
        }
      }
      function addRow() {
        const tr = document.createElement("tr");
        let middleCols = "";

        if (currentCategory === "food") {
          middleCols = `
      <td><input class="spec-a-input" placeholder="大/小,加麵等"></td>
      <td><input class="spec-b-input" placeholder="不蔥/加辣等"></td>
    `;
        } else {
          middleCols = `
      <td>
        <select class="spec-a-input">
          <option>正常糖</option><option>少糖</option><option>半糖</option>
          <option>微糖</option><option>二分糖</option><option>一分糖</option><option selected>無糖</option>
        </select>
      </td>
      <td>
        <select class="spec-b-input">
          <option>正常冰</option><option>少冰</option><option>微冰</option>
          <option>去冰</option><option selected>完全去冰</option><option>常溫</option><option>溫</option><option>熱</option>
        </select>
      </td>
    `;
        }

        tr.innerHTML = `
    <td><input class="who" placeholder="姓名" required></td>
    <td><input class="drink" placeholder="請輸入名稱" required></td>
    ${middleCols}
    <td><input class="qty" type="number" min="1" value="1"></td>
    <td><button type="button" class="del-btn" onclick="this.parentElement.parentElement.remove()">刪除</button></td>
  `;
        document.querySelector("#itemsTbl tbody").appendChild(tr);
      }

      async function submitOrder() {
        if (isExpired) {
          alert("訂單已截止，無法送出！");
          return;
        }

        const trs = [...document.querySelectorAll("#itemsTbl tbody tr")];
        if (trs.length === 0) return alert("請至少新增一筆品項");

        const rows = trs.map((tr) => ({
          event_id: EVENT_ID,
          customer: tr.querySelector(".who").value.trim(),
          name: tr.querySelector(".drink").value.trim(),
          suger: tr.querySelector(".spec-a-input").value,
          ice: tr.querySelector(".spec-b-input").value,
          qty: parseInt(tr.querySelector(".qty").value),
        }));

        showLoading(true);
        try {
          const { error } = await supabase.from("orders").insert(rows);
          if (error) throw error;
          alert("訂單送出成功！");
          location.href = `summary.html?event=${EVENT_ID}`;
        } catch (err) {
          alert("送出失敗：" + err.message);
        } finally {
          showLoading(false);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        ensureEvent();
        document.getElementById("addItem").onclick = addRow;
        document.getElementById("submitBtn").onclick = submitOrder;
      });
    </script>
  </body>
</html>

<!--
beta version
-->
