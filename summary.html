<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>訂單彙整</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="css/summary_style.css" />
    <link rel="stylesheet" href="css/loading.css" />
    <link rel="stylesheet" href="css/copyright_style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <div class="marquee-bar">
      <div class="marquee-content">
        ⚠️
        系統不會儲存您的訂單編號，請務必點擊下方按鈕「複製編號」並妥善保存，以便日後查詢訂單明細！
        ⚠️
      </div>
    </div>

    <div id="loadingOverlay">
      <div class="spinner-box">
        <div class="spinner"></div>
        <div class="spinner-text">正在讀取該訂單...</div>
      </div>
    </div>

    <div class="wrap">
      <div class="card">
        <h1 class="page-title">訂單彙整</h1>

        <div class="id-copy-section">
          <div class="id-label">訂單編號</div>
          <div class="id-display-row">
            <span id="targetOrderId">載入中...</span>
            <button id="btnCopy" class="copy-action-btn">複製編號</button>
          </div>
          <div id="copyToast" class="copy-toast">已複製到剪貼簿</div>
        </div>

        <div id="eventInfo"></div>

        <div id="byPersonBox" class="by-person">
          <h3 class="section-title">依人統計清單</h3>
          <div id="byPersonList"></div>
        </div>

        <div class="actions">
          <a href="index.html" class="back-home">回首頁</a>
          <button id="btnReload" type="button" class="back-home">
            重新整理資料
          </button>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="footer-content">
        <p>© 2025 曾可愛家族點餐系統</p>
        <p class="disclaimer">本站所有品牌標誌及菜單資訊之著作權均屬原公司所有。本系統為非營利開發練習，與上述品牌無官方關聯。</p>
      </div>
    </footer>
    <script type="module">
      import { supabase } from "./config.js";

      const eventId = new URLSearchParams(location.search).get("event");
      const btnCopy = document.getElementById("btnCopy");
      const copyToast = document.getElementById("copyToast");
      const targetOrderId = document.getElementById("targetOrderId");

      btnCopy.onclick = () => {
        if (!eventId) return;
        navigator.clipboard.writeText(eventId).then(() => {
          copyToast.style.display = "block";
          btnCopy.innerText = "已複製";
          setTimeout(() => {
            copyToast.style.display = "none";
            btnCopy.innerText = "複製編號";
          }, 2000);
        });
      };

      function showLoading(show) {
        document.getElementById("loadingOverlay").style.display = show
          ? "flex"
          : "none";
      }

      function formatTWTime(isoString) {
        if (!isoString) return "無限制";
        const date = new Date(isoString);
        return date.toLocaleString("zh-TW", {
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
          timeZone: "Asia/Taipei",
        });
      }

      async function load() {
        if (!eventId) {
          alert("網址缺少訂單編號，請重新從首頁進入。");
          location.href = "index.html";
          return;
        }

        targetOrderId.innerText = eventId;
        showLoading(true);

        try {
          const { data: results, error } = await supabase
            .from("events")
            .select("*, orders(*)")
            .eq("id", eventId);

          if (error) throw error;
          if (!results || results.length === 0) {
            document.getElementById("eventInfo").innerHTML =
              `<p style="color:red; text-align:center;">找不到此活動。</p>`;
            return;
          }

          const ev = results[0];
          document.getElementById("eventInfo").innerHTML = `
            <div class="meta-container" style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1.5px solid #1e293b; margin-bottom: 25px;">
              <h2 style="text-align:center; margin:0 0 10px 0;">${ev.shop}</h2>
              <p style="text-align:center; color:#e11d48; font-weight:bold; margin: 5px 0;">
                截止時間：${formatTWTime(ev.deadline)}
              </p>
            </div>`;

          const listEl = document.getElementById("byPersonList");
          listEl.innerHTML = "";
          const groups = {};
          const orders = ev.orders || [];

          if (orders.length === 0) {
            listEl.innerHTML =
              '<p style="text-align:center; color:#94a3b8; padding: 40px 0;">目前尚無人下單。</p>';
          } else {
            orders.forEach((o) => {
              if (!groups[o.customer]) groups[o.customer] = [];
              groups[o.customer].push(o);
            });

            Object.keys(groups)
              .sort()
              .forEach((name) => {
                const items = groups[name]
                  .map(
                    (o) => `
                <li>
                  <span>${o.name} (${o.suger}／${o.ice})</span>
                  <span style="font-weight:bold;">x${o.qty}</span>
                </li>
              `,
                  )
                  .join("");
                const div = document.createElement("div");
                div.className = "person";
                div.innerHTML = `<h4>${name}</h4><ul>${items}</ul>`;
                listEl.appendChild(div);
              });
          }
        } catch (err) {
          alert("讀取失敗：" + err.message);
        } finally {
          showLoading(false);
        }
      }

      document.getElementById("btnReload").onclick = () => load();
      document.addEventListener("DOMContentLoaded", load);
    </script>
  </body>
</html>

<!--
beta version
-->
