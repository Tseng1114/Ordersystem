<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>訂單彙整</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- 你的樣式檔如果已有 loading 的 spinner 樣式，保留就好；沒有可自行增補 -->
  <link rel="stylesheet" href="css/summary_style.css">
  <link rel="stylesheet" href="css/loading.css">
</head>
<body>
  <!-- ✅ 載入畫面（依你提供的結構） -->
  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      <div class="spinner-text">處理中，請稍候...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1 class="page-title">訂單彙整</h1>
      <div id="eventInfo" class="meta"></div>
      <div id="error" class="error" style="color:#c00"></div>

      <div id="byPersonBox" class="by-person hidden">
        <h3 class="section-title">依人統計</h3>
        <div id="byPersonList"></div>
        <div id="byPersonEmpty" class="hidden empty-hint">目前沒有任何訂單。</div>
      </div>

      <div class="actions">
        <a href="index.html" class="back-home">回首頁</a>
        <button id="btnReload" type="button" class="back-home" style="margin-left:8px;">重新整理</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const { WEB_APP_URL } = (window.APP_CONFIG || {});
    const urlParams = new URLSearchParams(location.search);

    function showLoading(show) {
      const el = document.getElementById('loadingOverlay');
      if (!el) return;
      el.style.display = show ? 'flex' : 'none';
    }

    showLoading(true);

    function jsonp(action, params = {}, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        if (!WEB_APP_URL) return reject(new Error('缺少 WEB_APP_URL（請在 config.js 設定）'));

        const cb = '__jp_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => { cleanup(); resolve(data); };

        const q = new URLSearchParams({ action, callback: cb, ts: Date.now() });
        for (const [k, v] of Object.entries(params)) {
          if (v === undefined || v === null) continue;
          q.append(k, String(v));
        }

        const s = document.createElement('script');
        s.src = WEB_APP_URL + '?' + q.toString();
        s.async = true;

        const timer = setTimeout(() => { cleanup(); reject(new Error('JSONP 請求逾時：' + s.src)); }, timeoutMs);

        function cleanup() {
          clearTimeout(timer);
          if (s.parentNode) s.parentNode.removeChild(s);
          try { delete window[cb]; } catch (_) { window[cb] = undefined; }
        }

        s.onerror = () => { cleanup(); reject(new Error('JSONP 載入失敗：' + s.src)); };
        document.head.appendChild(s);
      });
    }

    function escapeHtml(str){
      return String(str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function toDate(v){
      if (!v && v!==0) return null;
      if (v instanceof Date) return isNaN(v) ? null : v;
      const d = new Date(String(v)); return isNaN(d) ? null : d;
    }
    const pad = n => String(n).padStart(2,'0');
    function fmtTs(d){
      if (!d) return '-';
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function firstNonEmpty(list){
      for (const v of list){
        const s = (v == null ? '' : String(v)).trim();
        if (s) return s;
      }
      return '';
    }
    const getSugar = o => firstNonEmpty([o.sugar, o.sweet, o.suger]);
    const getIce   = o => firstNonEmpty([o.ice, o.iceLevel]);

    async function ensureEventId() {
      const eid = urlParams.get('event');
      if (eid && eid.trim()) return eid;

      const r = await jsonp('latestEvent');
      if (!r || r.ok !== true || !r.id) throw new Error((r && r.error) || '目前沒有活動');

      const url = location.pathname + '?event=' + encodeURIComponent(r.id) + '&r=' + Date.now();
      location.replace(url);
      return null;
    }

    async function load() {
      const errorEl = document.getElementById('error');
      const eventInfoEl = document.getElementById('eventInfo');
      const byPersonBox = document.getElementById('byPersonBox');
      const byPersonList = document.getElementById('byPersonList');
      const byPersonEmpty = document.getElementById('byPersonEmpty');

      try {
        showLoading(true);
        errorEl.textContent = '';
        byPersonBox.classList.add('hidden');
        byPersonList.innerHTML = '';

        const eventId = urlParams.get('event') || await ensureEventId();
        if (!eventId) return;

        const evRes = await jsonp('getEvent', { eventId });
        if (!evRes || evRes.ok !== true) throw new Error((evRes && evRes.error) || 'getEvent 失敗');
        const ev = evRes.event || {};

        let deadlineText = fmtTs(toDate(ev.deadline));
        if (deadlineText === '-') deadlineText = escapeHtml(ev.deadline || '-');

        eventInfoEl.innerHTML = `
          <h2 class="event-title">${escapeHtml(ev.title || eventId)}</h2>
          <div class="info-bar">
            <span class="chip shop-chip"><span class="label">店家</span><b>${escapeHtml(ev.shop || '-')}</b></span>
            <span class="chip deadline-badge"><span class="label">截止</span><b>${deadlineText}</b></span>
          </div>
        `;

        const agg = await jsonp('aggregatePublic', { eventId });
        if (!agg || agg.ok !== true) throw new Error((agg && agg.error) || 'aggregatePublic 失敗');

        const byPerson = agg.byPerson || {};
        const people = Object.keys(byPerson).sort((a,b)=>a.localeCompare(b,'zh-Hant'));

        byPersonBox.classList.remove('hidden');

        if (!people.length) {
          byPersonEmpty.classList.remove('hidden');
          showLoading(false);
          return;
        }
        byPersonEmpty.classList.add('hidden');

        people.forEach(name => {
          const orders = (byPerson[name] || []).slice().sort((a,b)=>String(a.name||'').localeCompare(String(b.name||''),'zh-Hant'));
          const items = orders.map(o=>{
            const sugar = getSugar(o);
            const ice   = getIce(o);
            const qty = Number(o.qty || 1);
            const note = o.notes ? `（${escapeHtml(o.notes)}）` : '';
            return `<li>${escapeHtml(o.name || '未填品項')}／${escapeHtml(sugar || '-')}／${escapeHtml(ice || '-')} × ${qty}${note}</li>`;
          }).join('');
          const box = document.createElement('div');
          box.className = 'person';
          box.innerHTML = `<h4>${escapeHtml(name)}</h4><ul>${items}</ul>`;
          byPersonList.appendChild(box);
        });

        showLoading(false);
      } catch (err) {
        showLoading(false);
        const errorEl = document.getElementById('error');
        errorEl.textContent = '載入失敗：' + (err && err.message ? err.message : err);
        console.error(err);
      }
    }

    document.getElementById('btnReload')?.addEventListener('click', () => {
      showLoading(true);
      const u = new URL(location.href);
      u.searchParams.set('r', Date.now());
      location.replace(u.toString());
    });

    load();
  </script>
</body>
</html>
