<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>訂單彙整</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/summary_style.css">
  <link rel="stylesheet" href="css/loading.css">
  <style>
    /* 這裡放一些關鍵的強制修正規範，確保 Bug 不再出現 */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      <div class="spinner-text">處理中，請稍候...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1 class="page-title">訂單彙整</h1>

      <div id="eventInfo"></div>

      <div id="error" class="error" style="color:#c00; text-align:center; margin:10px 0;"></div>

      <div id="byPersonBox" class="by-person hidden">
        <h3 class="section-title">依人統計</h3>
        <div id="byPersonList"></div>
        <div id="byPersonEmpty" class="hidden empty-hint" style="text-align:center; padding:20px; color:#64748b;">目前沒有任何訂單。</div>
      </div>

      <div class="actions">
        <a href="index.html" class="back-home">回首頁</a>
        <button id="btnReload" type="button" class="back-home" style="margin-left:8px;">重新整理</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const { WEB_APP_URL } = (window.APP_CONFIG || {});
    const urlParams = new URLSearchParams(location.search);

    function showLoading(show) {
      const el = document.getElementById('loadingOverlay');
      if (el) el.style.display = show ? 'flex' : 'none';
    }

    function jsonp(action, params = {}, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        if (!WEB_APP_URL) return reject(new Error('缺少 WEB_APP_URL'));
        const cb = '__jp_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => { cleanup(); resolve(data); };
        const q = new URLSearchParams({ action, callback: cb, ts: Date.now() });
        for (const [k, v] of Object.entries(params)) {
          if (v !== undefined && v !== null) q.append(k, String(v));
        }
        const s = document.createElement('script');
        s.src = WEB_APP_URL + '?' + q.toString();
        s.async = true;
        const timer = setTimeout(() => { cleanup(); reject(new Error('請求逾時')); }, timeoutMs);
        function cleanup() {
          clearTimeout(timer);
          if (s.parentNode) s.parentNode.removeChild(s);
          delete window[cb];
        }
        s.onerror = () => { cleanup(); reject(new Error('載入失敗')); };
        document.head.appendChild(s);
      });
    }

    function escapeHtml(str){
      return String(str||"").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }
    function toDate(v){
      if (!v && v!==0) return null;
      const d = new Date(String(v)); return isNaN(d) ? null : d;
    }
    const pad = n => String(n).padStart(2,'0');
    function fmtTs(d){
      if (!d) return '-';
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    async function ensureEventId() {
      const eid = urlParams.get('event');
      if (eid) return eid;
      const r = await jsonp('latestEvent');
      if (r && r.ok && r.id) {
        location.replace(location.pathname + '?event=' + r.id);
        return null;
      }
      throw new Error('目前沒有進行中的活動');
    }

    async function load() {
      const eventInfoEl = document.getElementById('eventInfo');
      const byPersonBox = document.getElementById('byPersonBox');
      const byPersonList = document.getElementById('byPersonList');
      const byPersonEmpty = document.getElementById('byPersonEmpty');
      const errorEl = document.getElementById('error');

      try {
        showLoading(true);
        byPersonList.innerHTML = '';
        byPersonEmpty.classList.add('hidden');
        errorEl.textContent = '';

        const eventId = await ensureEventId();
        if (!eventId) return;

        const evRes = await jsonp('getEvent', { eventId });
        if (!evRes || !evRes.ok) throw new Error('無法取得活動資訊');
        const ev = evRes.event || {};

        let deadlineText = fmtTs(toDate(ev.deadline));
        if (deadlineText === '-') deadlineText = escapeHtml(ev.deadline || '-');

        eventInfoEl.innerHTML = `
          <div class="meta-container">
            <div class="event-title-box">ID: ${escapeHtml(ev.id || eventId)}</div>
            <div class="info-row">
              <div class="shop-box">
                <span class="label">店家</span>
                <div class="value">${escapeHtml(ev.shop || '-')}</div>
              </div>
              <div class="deadline-box">
                <span class="label">截止日期</span>
                <div class="value">${deadlineText}</div>
              </div>
            </div>
          </div>
        `;

        const agg = await jsonp('aggregatePublic', { eventId });
        const byPerson = agg.byPerson || {};
        const people = Object.keys(byPerson).sort((a,b)=>a.localeCompare(b,'zh-Hant'));

        byPersonBox.classList.remove('hidden');

        if (people.length === 0) {
          byPersonEmpty.classList.remove('hidden');
        } else {
          byPersonEmpty.classList.add('hidden');
          people.forEach(name => {
            const orders = byPerson[name] || [];
            const items = orders.map(o => {
              const sugar = o.sugar || o.sweet || '-';
              const ice = o.ice || o.iceLevel || '-';
              return `<li>${escapeHtml(o.name)}／${escapeHtml(sugar)}／${escapeHtml(ice)} × ${o.qty || 1}</li>`;
            }).join('');
            const box = document.createElement('div');
            box.className = 'person';
            box.innerHTML = `<h4>${escapeHtml(name)}</h4><ul>${items}</ul>`;
            byPersonList.appendChild(box);
          });
        }
      } catch (err) {
        errorEl.textContent = '錯誤：' + err.message;
      } finally {
        showLoading(false);
      }
    }

    document.getElementById('btnReload').onclick = () => location.reload();
    load();
  </script>
</body>
</html>