<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>彙整</title>
  <link rel="stylesheet" href="css/order_style.css">
  <style>
    .meta{
       color:#666;
       margin:8px 0 12px
     }
    .controls{
       display:flex;
       gap:10px;
       margin:8px 0 12px
    }
    .names{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
      gap:10px 14px
    }
    .pill{
      background:#eef1f5;
      border:1px solid #e0e4ea;
      padding:10px 12px;
      border-radius:999px;
      text-align:center;
      font-weight:600
    }
    .by-person{
      margin-top:20px;
      display:grid;
      gap:12px
    }
    .person{
      padding:12px 14px;
      border:1px solid #e9edf2;
      border-radius:12px;
      background:#fafbfc
    }
    .person h4{
      margin:0 0 8px;
      font-size:16px
    }
    .person ul{
      margin:0;
      padding-left:18px
    }
    .hidden{
      display:none
    }
    .error{
      color:#b00020;
      margin-top:8px
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="page-title">彙整</h1>

    <div id="loginCard" class="card">
      <label for="pass">管理者通關碼</label>
      <input id="pass" type="password" placeholder="請輸入通關碼">
      <div class="actions">
        <a class="back-home" href="index.html">回首頁</a>
        <button class="primary" id="loginBtn" type="button">登入</button>
      </div>
    </div>

    <div id="contentCard" class="card hidden">
      <div id="meta" class="meta"></div>
      <div id="error" class="error"></div>

      <h3 style="margin:6px 0;">誰有點</h3>
      <div id="list" class="names"></div>

      <h3 style="margin:20px 0 6px;">誰點什麼</h3>
      <div id="byPerson" class="by-person"></div>
    </div>
  </div>

  <script>
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbx-aHee4_Fyo1bsiK_SK6jXK2F0QMwQaqyo-iw1nOGS_Fpmes0LLdEZK3Jl2DDVDLk/exec';
  const TOKEN_KEY = 'drinksys_token';

  async function apiGet(params) {
    const url = new URL(WEB_APP_URL);
    Object.entries(params || {}).forEach(([k, v]) => url.searchParams.set(k, v));
    const res = await fetch(url.toString(), { credentials: 'omit' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function getToken() {
    try {
      return sessionStorage.getItem(TOKEN_KEY) ||
             localStorage.getItem(TOKEN_KEY) || '';
    } catch (_) { return ''; }
  }
  function setToken(t) {
    try {
      sessionStorage.setItem(TOKEN_KEY, t);
      localStorage.setItem(TOKEN_KEY, t);
    } catch (_) {}
  }

  function esc(s){
    return String(s)
      .replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }

  const $status  = document.querySelector('#status');
  const $names   = document.querySelector('#names');
  const $by      = document.querySelector('#byPerson');
  const $login   = document.querySelector('#adminLogin');
  const $pass    = document.querySelector('#sumPass');
  const $btnLog  = document.querySelector('#sumLoginBtn');

  const EVENT_ID = new URL(location.href).searchParams.get('event') || '';

  async function loginAdmin() {
    const pass = $pass.value.trim();
    if (!pass) { alert('請輸入通關碼'); return; }
    try {
      const r = await apiGet({ action:'login', pass });
      if (!r.ok) throw new Error(r.error || 'login failed');
      setToken(r.token || '');
      $login.style.display = 'none';
      await loadAll(); // 重新載入
    } catch (err) {
      alert('登入失敗：' + (err.message || err));
    }
  }
  $btnLog?.addEventListener('click', loginAdmin);

  async function loadAll() {
    if (!EVENT_ID) { alert('缺少 event 參數'); return; }

    try {
      const info = await apiGet({ action:'getEvent', event: EVENT_ID });
      const st = (info.status || 'open').toLowerCase();
      const dl = info.deadline || '';
      if ($status) {
        $status.textContent = `狀態：${st}｜截止：${dl || '—'}`;
      }
      document.title = `${info.shop || ''} 的彙整`;
    } catch (err) {
      console.warn('getEvent error:', err);
    }

    const token = getToken();
    if (!token) {
      $login.style.display = 'block';
      renderNoOrders('（尚無訂單，或需登入）');
      return;
    }

    try {
      const res = await apiGet({ action:'listOrders', event: EVENT_ID, token });
      if (!res.ok) {
        if (/auth|token|denied|forbidden/i.test(res.error || '')) {
          $login.style.display = 'block';
          renderNoOrders('（請先登入管理者）');
          return;
        }
        throw new Error(res.error || 'listOrders failed');
      }
      renderOrders(res.orders || []);
    } catch (err) {
      console.warn('listOrders error:', err);
      $login.style.display = 'block';
      renderNoOrders('（讀取失敗，請登入後重試）');
    }
  }

  function renderNoOrders(msg) {
    if ($names) $names.innerHTML = `<div class="pill">${esc(msg || '（尚無訂單）')}</div>`;
    if ($by)    $by.innerHTML    = `<div class="empty">${esc(msg || '（尚無明細）')}</div>`;
  }

  function renderOrders(list) {
    if (!list.length) { renderNoOrders('（尚無訂單）'); return; }

    const people = Array.from(new Set(list.map(o => String(o.who || '').trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'zh-Hant'));
    if ($names) $names.innerHTML = people.map(n => `<div class="pill">${esc(n)}</div>`).join('');

    const map = new Map();
    list.forEach(o => {
      const who = String(o.who || '').trim() || '（未填名）';
      if (!map.has(who)) map.set(who, []);
      map.get(who).push(o);
    });

    if ($by) {
      const blocks = people.map(name => {
        const items = (map.get(name) || []).map(o => {
          const drink = esc(String(o.name || '（未填品項）'));
          const sugar = esc(String(o.sugar || '—'));
          const ice   = esc(String(o.ice   || '—'));
          const qty   = Number(o.qty || 0) || 1;
          return `<li>${drink}／${sugar}／${ice} × ${qty}</li>`;
        }).join('');
        return `<div class="person"><h4>${esc(name)}</h4><ul>${items}</ul></div>`;
      }).join('');
      $by.innerHTML = blocks || '<div class="empty">（尚無明細）</div>';
    }
  }

  loadAll();
</script>

</body>
</html>
