<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>訂單彙整</title>
  <link rel="stylesheet" href="css/summary_style.css">
  <link rel="stylesheet" href="css/loading.css">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      <div style="margin-top:10px;">處理中，請稍候...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1 class="page-title">訂單彙整</h1>

      <div id="eventInfo" class="meta"></div>
      <div id="error" class="error"></div>

      <div id="byPersonBox" class="by-person hidden">
        <h3 style="margin:18px 0 8px;">依人統計</h3>
        <div id="byPersonList"></div>
        <div id="byPersonEmpty" class="hidden" style="color:#777;text-align:center;margin-top:8px;">目前沒有任何訂單。</div>
      </div>

      <div class="actions">
        <a href="index.html" class="back-home">回首頁</a>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const { WEB_APP_URL, TOKEN_KEY } = window.APP_CONFIG;
    const params = new URLSearchParams(location.search);

    function showLoadingOverlay(show){
      const el = document.getElementById("loadingOverlay");
      if (!el) return;
      el.style.display = show ? "block" : "none";
    }
    function getToken(){
      try {
        return sessionStorage.getItem(TOKEN_KEY) || localStorage.getItem(TOKEN_KEY) || "";
      } catch { return ""; }
    }
    function jsonp(url, params) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Date.now() + Math.random().toString(36).slice(2);
        params.callback = cb;
        const qs = new URLSearchParams(params).toString();
        const s = document.createElement("script");
        s.src = url + "?" + qs;
        window[cb] = (data) => { resolve(data); cleanup(); };
        s.onerror = () => { reject(new Error("JSONP failed")); cleanup(); };
        function cleanup(){ delete window[cb]; s.remove(); }
        document.body.appendChild(s);
      });
    }
    function pick(...candidates){
      for (const v of candidates) if (v !== undefined && v !== null && String(v).trim() !== "") return String(v);
      return "";
    }
    function fmt(value, fallback){ return (value && String(value).trim() !== "") ? value : fallback; }

    async function ensureEventParam(){
      let eventId = params.get("event");
      if (eventId && eventId.trim()) return eventId;

      const res = await jsonp(WEB_APP_URL, { action: "latestEvent", _ts: Date.now() });
      if (!res || !res.ok) throw new Error(res && res.error ? res.error : "latestEvent 失敗");
      if (!res.id) throw new Error("目前沒有任何活動可顯示");
      eventId = res.id;
      location.replace(location.pathname + "?event=" + encodeURIComponent(eventId));
      return null;
    }

    async function load() {
      showLoadingOverlay(true);
      const errorEl = document.getElementById("error");
      const byPersonBox = document.getElementById("byPersonBox");
      const list = document.getElementById("byPersonList");

      try{
        const eventId = params.get("event") || await ensureEventParam();
        if (!eventId) return;

        document.getElementById("eventInfo").textContent = `近期訂單：${eventId}`;

        let data;
        const token = getToken();
        if (token) {
          data = await jsonp(WEB_APP_URL, { action: "aggregate", eventId, token, _ts: Date.now() });
          if (!data || data.ok !== true) data = null;
        }
        if (!data) {
          data = await jsonp(WEB_APP_URL, { action: "aggregatePublic", eventId, _ts: Date.now() });
        }
        if (!data || data.ok !== true) throw new Error(data && data.error ? data.error : "無法載入資料");

        const byPerson = data.byPerson || {};
        const people = Object.keys(byPerson);
        byPersonBox.classList.remove("hidden");
        list.innerHTML = "";

        if (people.length === 0) {
          document.getElementById("byPersonEmpty").classList.remove("hidden");
          showLoadingOverlay(false);
          return;
        }
        document.getElementById("byPersonEmpty").classList.add("hidden");

        people.sort((a,b)=>a.localeCompare(b,"zh-Hant"));
        people.forEach(name => {
          const orders = byPerson[name] || [];
          const box = document.createElement("div");
          box.className = "person";
          const items = orders.map(o => {
            const sugar = pick(o.sugar, o.sweet, o.suger);
            const ice   = pick(o.ice, o.iceLevel);
            const qty   = Number(o.qty || 1);
            const sugarText = "／" + fmt(sugar, "未選甜度");
            const iceText   = "／" + fmt(ice, "未選冰量");
            const notesText = o.notes ? `（${o.notes}）` : "";
            return `<li>${fmt(o.name, "未填品項")}${sugarText}${iceText} × ${qty}${notesText}</li>`;
          }).join("");
          box.innerHTML = `<h4>${name}</h4><ul>${items}</ul>`;
          list.appendChild(box);
        });

        showLoadingOverlay(false);
      } catch (err) {
        showLoadingOverlay(false);
        errorEl.textContent = "載入失敗：" + (err && err.message ? err.message : err);
      }
    }
    load();
  </script>
</body>
</html>
