<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>訂單彙整</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/summary_style.css">
  <link rel="stylesheet" href="css/loading.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div id="loadingOverlay">
    <div class="spinner-box">
      <div class="spinner"></div>
      <div class="spinner-text">正在讀取該訂單...</div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h1 class="page-title">訂單彙整</h1>

      <div id="eventInfo"></div>

      <div id="byPersonBox" class="by-person">
        <h3 class="section-title">依人統計清單</h3>
        <div id="byPersonList"></div>
      </div>

      <div class="actions">
        <a href="index.html" class="back-home">回首頁</a>
        <button id="btnReload" type="button" class="back-home">重新整理資料</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const { SUPABASE_URL, SUPABASE_KEY } = window.APP_CONFIG;
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const eventId = new URLSearchParams(location.search).get('event');

    function showLoading(show) {
      document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
    }

    function formatTWTime(isoString) {
      if (!isoString) return '無限制';
      const date = new Date(isoString);
      return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
        timeZone: 'Asia/Taipei'
      });
    }

    async function load() {
      if (!eventId) {
        alert('網址缺少訂單編號，請重新從首頁進入或輸入編號。');
        location.href = 'index.html';
        return;
      }

      showLoading(true);

      try {
        const { data: results, error } = await _supabase
          .from('events')
          .select('*, orders(*)')
          .eq('id', eventId);

        if (error) throw error;

        if (!results || results.length === 0) {
          document.getElementById('eventInfo').innerHTML = `<p style="color:red; text-align:center;">找不到此編號 (${eventId}) 的活動。</p>`;
          return;
        }

        const ev = results[0];

        const infoEl = document.getElementById('eventInfo');
        infoEl.innerHTML = `
          <div class="meta-container" style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1.5px solid #1e293b; margin-bottom: 25px;">
            <h2 style="text-align:center; margin:0 0 10px 0; color:#1e293b;">${ev.shop}</h2>
            <p style="text-align:center; color:#64748b; font-size: 0.85em; margin: 5px 0; word-break: break-all;">
              訂單編號：<span style="user-select: all; background:#eee; padding:2px 4px;">${ev.id}</span>
            </p>
            <p style="text-align:center; color:#e11d48; font-weight:bold; margin: 5px 0;">
              截止時間：${formatTWTime(ev.deadline)}
            </p>
          </div>`;

        const listEl = document.getElementById('byPersonList');
        listEl.innerHTML = '';

        const groups = {};
        const orders = ev.orders || [];

        if (orders.length === 0) {
          listEl.innerHTML = '<p style="text-align:center; color:#94a3b8; padding: 40px 0;">目前尚無人下單。</p>';
        } else {
          orders.forEach(o => {
            if (!groups[o.customer]) groups[o.customer] = [];
            groups[o.customer].push(o);
          });

          Object.keys(groups).sort().forEach(name => {
            const items = groups[name].map(o => `
              <li style="margin-bottom: 6px;">
                <span style="font-weight:500;">${o.name}</span>
                <span style="color:#64748b;">(${o.suger}／${o.ice})</span>
                <span style="color:#1e293b; font-weight:bold;">x${o.qty}</span>
              </li>
            `).join('');

            const div = document.createElement('div');
            div.className = 'person';
            div.style = "margin-bottom: 20px; padding: 15px; border-bottom: 1px solid #e2e8f0;";
            div.innerHTML = `
              <h4 style="margin: 0 0 10px 0; color:#1e293b; border-left: 4px solid #f59e0b; padding-left: 10px;">${name}</h4>
              <ul style="list-style: none; padding-left: 15px; margin: 0;">${items}</ul>
            `;
            listEl.appendChild(div);
          });
        }

      } catch (err) {
        console.error('載入失敗:', err);
        alert('讀取資料發生錯誤：' + err.message);
      } finally {
        showLoading(false);
      }
    }

    document.getElementById('btnReload').onclick = () => load();

    document.addEventListener('DOMContentLoaded', load);
  </script>
</body>
</html>